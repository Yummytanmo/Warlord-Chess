# Implementation Plan: Implement Hero Skills

**Branch**: `006-add-hero-skills` | **Date**: 2026-01-07
**Input**: Feature specification from `/specs/006-add-hero-skills/spec.md`

## Summary
Implement hero skills for Xiangyu, Liubang, Hanxin, Xiaohe, Zhangliang, and Fankui. This involves updating `RuleContext` for passive move modifiers, and extending `GameState` and `SkillEngine` to support complex active skills (pawn placement, piece exchange, multi-stage turns).

## Technical Context
**Language/Version**: TypeScript 5.x
**Primary Dependencies**: Next.js, Zustand, Konva.js (UI)
**Storage**: In-memory (Zustand store)
**Testing**: Vitest, Property-based testing (fast-check)
**Target Platform**: Web (Modern Browsers)
**Project Type**: Web application
**Performance Goals**: 60fps rendering, instant skill feedback.

## Constitution Check
- **Player Experience**: Skills add depth. UI must be clear for complex skills (e.g. placing pawns).
- **Test Priority**: Each skill needs unit tests. Complex state transitions (Hanxin, Xiaohe) need property tests.
- **Type Safety**: New state fields must be typed. Skill types extended.
- **Performance**: Pre-calculation for valid moves even with skill modifiers.

## Project Structure
### Documentation
```text
specs/006-add-hero-skills/
├── plan.md
├── research.md
├── data-model.md
└── tasks.md
```

### Source Code
```text
src/
├── lib/
│   ├── skills/              # New directory for specific hero skill implementations
│   │   ├── xiangyu.ts
│   │   ├── liubang.ts
│   │   ├── hanxin.ts
│   │   ├── xiaohe.ts
│   │   ├── zhangliang.ts
│   │   └── fankui.ts
│   ├── skillEngine.ts       # Update to support new triggers/states
│   ├── gameManager.ts       # Update to support multi-stage turns
│   └── pieceSetup.ts        # Update for Hanxin's initial state
├── types/
│   ├── game.ts              # Update GameState for markers/extra turns
│   └── rules.ts             # Ensure all flags covered
└── components/
    └── game/
        └── SkillInteraction.tsx # New component for active skill UI (place pawn, select piece)
```

## Phase 0: Outline & Research
1.  **Unknowns**:
    -   How to handle "Multi-stage Turn" in `GameManager`? (e.g. Zhangliang moving King then another piece).
    -   UI for "Place Pawn" (Hanxin).

2.  **Research Tasks**:
    -   [ ] Design state machine for multi-stage turns (e.g. `turnPhase`: 'normal' | 'extra_move').
    -   [ ] Define "Initial Position" logic for Xiaohe.

## Phase 1: Design & Contracts
1.  **Data Model**:
    -   Extend `GameState` with `skillState` (markers, custom data).
    -   Extend `Move` or create `SkillAction` type for placing pieces.
2.  **Contracts**:
    -   Define `SkillInteraction` interface for UI.

## Phase 2: Tasks & Implementation
(To be generated by `speckit.tasks`)