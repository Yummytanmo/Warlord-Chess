# Implementation Plan: Fix Long Check Draw Logic

**Branch**: `005-fix-long-check-draw` | **Date**: 2026-01-07
**Input**: Feature specification from `/specs/005-fix-long-check-draw/spec.md`

## Summary

Fix the broken "Long Check Draw" detection in `GameManager`. The current implementation incorrectly counts any move as a check. The fix involves adding an `isCheck` flag to the `Move` interface, calculating it during move execution, and using this flag to correctly count consecutive checks.

## Technical Context

**Language/Version**: TypeScript 5.x
**Primary Dependencies**: Next.js, Zustand, Konva.js (UI)
**Storage**: In-memory (Zustand store)
**Testing**: Vitest
**Target Platform**: Web (Modern Browsers)
**Project Type**: Web application
**Performance Goals**: Check detection must not degrade 60fps rendering.
**Constraints**: Must work within existing `GameManager` and `moveValidator` architecture.

## Constitution Check

*GATE: Must pass before Phase 0 research.*

- **Player Experience**: Fixes a critical bug that ruins gameplay. (Pass)
- **Test Priority**: Will add unit/integration tests for `GameManager` specific to check detection and draw conditions. (Pass)
- **Type Safety**: Will extend `Move` interface strictly. (Pass)
- **Performance**: Pre-calculating `isCheck` during move execution avoids expensive history re-simulation. (Pass)

## Project Structure

### Documentation (this feature)

```text
specs/005-fix-long-check-draw/
├── plan.md
├── research.md
├── data-model.md
└── tasks.md
```

### Source Code

```text
src/
├── lib/
│   ├── gameManager.ts       # Main logic update
│   └── board.ts
├── types/
│   └── game.ts              # Interface update
└── test/
    └── unit/
        └── gameManager.test.ts # New tests
```

## Phase 0: Outline & Research

1.  **Unknowns**:
    *   Does `ChessMoveValidator` already have a "isCheck" helper exposed efficiently? (Likely `isKingInCheck` exists but check usage).
    *   Exact rules for "Long Check": Is it 3 times per player (6 moves) or something else?

2.  **Research Tasks**:
    *   [ ] Verify `isKingInCheck` performance and usage in `GameManager`.
    *   [ ] Confirm existing tests for checkmate/check.

## Phase 1: Design & Contracts

1.  **Data Model**:
    *   Update `Move` interface in `src/types/game.ts` to add `isCheck: boolean`.

2.  **Logic**:
    *   Update `GameManager.executeMove` to calculate `isCheck` for the *opponent* after the move is made.
    *   Update `GameManager.getConsecutiveChecks` to read `isCheck` from history.

## Phase 2: Tasks & Implementation

(To be generated by `speckit.tasks`)